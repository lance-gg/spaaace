{"version":3,"sources":["../../src/server/SpaaaceServerEngine.js"],"names":["nameGenerator","require","NUM_BOTS","SpaaaceServerEngine","io","gameEngine","inputOptions","scoreData","on","e","roomName","missile","ownerId","kills","ship","id","updateScore","removeObjectFromWorld","socket","joinRoom","URL","handshake","headers","referer","username","playerId","emit","makePlayerShip","makeShip","assignObjectToRoom","name","socketId","playerObjects","world","queryObjects","forEach","obj","console","log","_roomName","setTimeout","sockets","ServerEngine"],"mappings":"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","sourcesContent":["import { getRoomAndUsername } from \"./RoomManager\";\nimport { ServerEngine } from \"lance-gg\";\nconst nameGenerator = require(\"./NameGenerator\");\nconst NUM_BOTS = 0;\n\nexport default class SpaaaceServerEngine extends ServerEngine {\n  constructor(io, gameEngine, inputOptions) {\n    super(io, gameEngine, inputOptions);\n    this.scoreData = {};\n  }\n\n  // when the game starts, create robot spaceships, and register\n  // on missile-hit events\n  start() {\n    super.start();\n\n    // Room IDs https://github.com/jungbeomsu/Test/blob/fe9474c67073121937726deb54f0e53eb11eb4c4/src/gameServer/TownServerEngine.js\n\n    // for (let x = 0; x < NUM_BOTS; x++) this.makeBot();\n\n    this.gameEngine.on(\"missileHit\", (e) => {\n      // add kills\n      const roomName = e.missile.roomName;\n      if (this.scoreData[roomName][e.missile.ownerId]) this.scoreData[roomName][e.missile.ownerId].kills++;\n\n      // remove score data for killed ship\n      delete this.scoreData[roomName][e.ship.id];\n      this.updateScore();\n\n      //   console.log(`ship killed: ${e.ship.toString()}`);\n      this.gameEngine.removeObjectFromWorld(e.ship.id);\n      //   if (e.ship.isBot) {\n      //     setTimeout(() => this.makeBot(), 5000);\n      //   }\n    });\n  }\n\n  // a player has connected\n  onPlayerConnected(socket) {\n    super.onPlayerConnected(socket);\n    this.joinRoom(socket);\n  }\n\n  async joinRoom(socket) {\n    const URL = socket.handshake.headers.referer;\n    const { roomName, username } = await getRoomAndUsername(URL);\n\n    super.createRoom(roomName);\n    super.assignPlayerToRoom(socket.playerId, roomName);\n    this.scoreData[roomName] = this.scoreData[roomName] || {};\n\n    if (username) {\n      socket.emit(\"inzone\");\n      let makePlayerShip = () => {\n        let ship = this.gameEngine.makeShip(socket.playerId);\n        this.assignObjectToRoom(ship, roomName);\n\n        this.scoreData[roomName][ship.id] = {\n          kills: 0,\n          name: username,\n        };\n        this.updateScore();\n      };\n      // handle client restart requests\n      socket.on(\"requestRestart\", makePlayerShip);\n    } else {\n      // User is spectating because not in private zone\n      socket.emit(\"spectating\");\n      this.updateScore();\n    }\n  }\n\n  // a player has disconnected\n  onPlayerDisconnected(socketId, playerId) {\n    super.onPlayerDisconnected(socketId, playerId);\n\n    // iterate through all objects, delete those that are associated with the player (ship and missiles)\n    let playerObjects = this.gameEngine.world.queryObjects({ playerId: playerId });\n    playerObjects.forEach((obj) => {\n      this.gameEngine.removeObjectFromWorld(obj.id);\n      console.log(obj);\n      //   // remove score associated with this ship\n      delete this.scoreData[obj._roomName][obj.id];\n    });\n\n    this.updateScore();\n  }\n\n  //   // create a robot spaceship\n  //   makeBot() {\n  //     let bot = this.gameEngine.makeShip(0);\n  //     bot.attachAI();\n  //     this.scoreData[bot.id] = {\n  //       kills: 0,\n  //       name: nameGenerator(\"general\") + \"Bot\",\n  //     };\n  //     this.updateScore();\n  //   }\n\n  updateScore() {\n    // delay so player socket can catch up\n    setTimeout(() => {\n      this.io.sockets.emit(\"scoreUpdate\", this.scoreData);\n    }, 1000);\n  }\n}\n"],"file":"SpaaaceServerEngine.js"}