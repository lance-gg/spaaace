{"version":3,"file":"MobileControls.js","names":["_eventEmitter","_interopRequireDefault","require","_Utils","obj","__esModule","_typeof","Symbol","iterator","constructor","prototype","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","protoProps","staticProps","arg","_toPrimitive","String","input","hint","prim","toPrimitive","undefined","res","call","Number","MobileControls","clientEngine","_this","assign","EventEmitter","renderer","touchContainer","document","querySelector","setupListeners","activeInput","up","left","right","onRequestAnimationFrame","handleMovementInput","window","requestAnimationFrame","gameEngine","on","keyName","sendInput","value","_this2","touchHandler","e","touch","targetTouches","currentTouch","x","pageX","y","pageY","type","emit","addEventListener","playerShip","preventDefault","onKeyChange","isDown","playerShipScreenCoords","gameCoordsToScreen","dx","dy","shortestArc","Utils","Math","atan2","sin","actor","shipContainerSprite","rotation","PI","cos","rotateThreshold","distanceThreshold","sqrt","exports"],"sources":["../../src/client/MobileControls.js"],"sourcesContent":["import EventEmitter from 'event-emitter';\nimport Utils from '../common/Utils';\n\n/**\n * This class handles touch device controls\n */\nexport default class MobileControls {\n\n    constructor(clientEngine){\n        Object.assign(this, EventEmitter.prototype);\n        this.clientEngine = clientEngine;\n        this.renderer = clientEngine.renderer;\n\n        this.touchContainer = document.querySelector('.pixiContainer');\n        this.setupListeners();\n\n        this.activeInput = {\n            up: false,\n            left: false,\n            right: false\n        };\n\n        let onRequestAnimationFrame = () => {\n            this.handleMovementInput();\n            window.requestAnimationFrame(onRequestAnimationFrame);\n        };\n        onRequestAnimationFrame();\n\n        this.clientEngine.gameEngine.on('client__preStep', ()=>{\n            for (let keyName in this.activeInput){\n                if (this.activeInput[keyName]){\n                    this.clientEngine.sendInput(keyName);\n                }\n            }\n        });\n\n    }\n\n    setupListeners(){\n        let touchHandler = (e) => {\n            // If there's exactly one finger inside this element\n            let touch = e.targetTouches[0];\n            this.currentTouch = {\n                x: touch.pageX,\n                y: touch.pageY\n            };\n\n            if (e.type === 'touchstart' && e.targetTouches[1]){\n                this.emit('fire');\n            }\n        };\n\n        this.touchContainer.addEventListener('touchstart', touchHandler, false);\n        this.touchContainer.addEventListener('touchmove', (e) =>{\n            touchHandler(e);\n            // if ingame prevent scrolling\n            if (this.renderer.playerShip) {\n                e.preventDefault();\n            }\n        }, false);\n\n        this.touchContainer.addEventListener('touchend', (e) => {\n            this.currentTouch = false;\n            this.activeInput.up = false;\n            this.activeInput.left = false;\n            this.activeInput.right = false;\n            this.renderer.onKeyChange({ keyName: 'up', isDown: false });\n        }, false);\n\n        document.querySelector('.fireButton').addEventListener('click', () => {\n            this.emit('fire');\n        });\n    }\n\n    handleMovementInput(){\n        // no touch, no movement\n        if (!this.currentTouch) return;\n\n        // by default no touch\n        this.activeInput.right = false;\n        this.activeInput.left = false;\n        this.activeInput.up = false;\n\n        let playerShip = this.renderer.playerShip;\n        // no player ship, no movement\n        if (!playerShip) return;\n\n        let playerShipScreenCoords = this.renderer.gameCoordsToScreen(playerShip);\n\n        let dx = this.currentTouch.x - playerShipScreenCoords.x;\n        let dy = this.currentTouch.y - playerShipScreenCoords.y;\n        let shortestArc = Utils.shortestArc(Math.atan2(dx, -dy),\n            Math.atan2(Math.sin(playerShip.actor.shipContainerSprite.rotation + Math.PI / 2), Math.cos(playerShip.actor.shipContainerSprite.rotation + Math.PI / 2)));\n\n        let rotateThreshold = 0.3;\n        let distanceThreshold = 120;\n\n        // turn left or right\n        if (shortestArc > rotateThreshold){\n            this.activeInput.left = true;\n            this.activeInput.right = false;\n        } else if (shortestArc < -rotateThreshold) {\n            this.activeInput.right = true;\n            this.activeInput.left = false;\n        }\n\n        // don't turn if too close\n        if (Math.sqrt(dx * dx + dy * dy) > distanceThreshold) {\n            this.activeInput.up = true;\n            this.renderer.onKeyChange({ keyName: 'up', isDown: true });\n        } else {\n            this.renderer.onKeyChange({ keyName: 'up', isDown: false });\n        }\n\n    }\n\n}\n"],"mappings":"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"}